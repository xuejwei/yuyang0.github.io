<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Linux平台C语言乱码</title>
<!-- 2013-07-14 Sun 18:21 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="generator" content="Org-mode"/>
<meta name="author" content="Yu Yang"/>
<meta name="keywords" content="linux c mess"/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="/static/css/main.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012  Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body><div id="header">
<div id="header-top">
  <div id="blog-title">Yu Yang's Writing Time</div>
  <div id="blog-sub-title">something about my thinking, doing and reading notes...</div>
</div>
<div id="nav">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/guestbook.html">留言板</a></li>
    <li><a href="/about.html">About Me</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    <li>
      <form action="/search.html">
        <input type="text" class="searchbox" name="wd" value="Search..." onblur="if(this.value==''){this.value='Search...';}" onfocus="if(this.value=='Search...'){this.value='';}"/>
        <input type="image" src="/static/img/google.ico" class="searchbox_submit" value="" />
      </form>
    </li>
  </ul>
  </div>
</div>

<div id="content">
<h1 class="title">Linux平台C语言乱码</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">文件加载到显示的过程</a></li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">文件加载到显示的过程</h2>
<div class="outline-text-2" id="text-1">
<p>
只要是用过linux的人都应该遇到过乱码的问题，众所周知，乱码的产生的主要原因是编
码的问题，以B编码方式去读取以A编码方式编码的文件时就会产生乱码，文件读取到显示
的过程可以简单的用下图表表示：
</p>

<div class="figure">
<p><img src="static/img/how-to-show-file.png"  alt="how-to-show-file.png"/></p>
</div>

<ul class="org-ul">
<li>第一步是将文件读入内存，这一步可以看作是直接将文件的二进制形式的表示直接复制
进内存，就是将你用十六进制工具看到的那些东西复制进内存，
</li>
<li>第二步是显示终端将内存中的数据以某种编码方式解码显示出来
</li>
</ul>
<p>
在linux下这种显示终端的默认编码方式一般是utf8，windows则是gb2312，从这里可以看出，在linux下要不产生乱码，必须
让内存中的二进制数据是对原始信息通过utf8编码得到的，那么如何保证这一点呢，有
两种方式，一种是让文件本身是utf8编码的，这样读入内存后在以utf8解码后得到的信
息肯定一样，也就是不会有乱码，第二种是直接在内存中转换，假设我读一个以gb2312
编码的文件，在内存中得到一个缓冲区buf，如果你直接将buf传送给显示终端的话，那
么显示终端就会以utf8对buf的二进制数据解码，那么就会产生乱码，因为buf的二进制
数据是以gb2312对原始信息编码得到的，这就是为什么很多windows创建的文件在linux
读取时会乱码，那么我要正常显示，则必须将buf中的二进制数据转换为将原始信息以utf8
编码得到的二进制信息，这里分两种情况讨论:
</p>

<ol class="org-ol">
<li>文本文件的编码格式是utf8，这种情况可以直接用c语言读取显示，不会产生乱码，
所以不过多赘述
</li>
<li>文本文件的编码是gb2312，那么直接用C语言操作时就会产生乱码，这种情况的解决方
式主要有两种，第一种就是运行程序之前将要操作的文本文件转换为utf8，打开shell，
输入以下命令:
iconv -f gb2312 -t utf8 youfile -c -o newfile
</li>
</ol>

<p>
其中youfile是要转换的文件，newfile就是得到的utf8编码的文件，其中c这个参数建议加上，
它可以忽略无效的字符，比如可以忽略utf8文件里的BOM，下面贴一段转换歌词编码的脚本给大
家参考:
</p>
<div class="org-src-container">

<pre class="src src-sh"><span class="linenr"> 1: </span><span style="color: #AEAEAE; font-style: italic;">#</span><span style="color: #AEAEAE; font-style: italic;">!/bin/</span><span style="color: #FBDE2D;">bash</span>
<span class="linenr"> 2: </span><span style="color: #FBDE2D;">for</span> i<span style="color: #FBDE2D;"> in</span> *.lrc
<span class="linenr"> 3: </span><span style="color: #FBDE2D;">do</span>
<span class="linenr"> 4: </span>    <span style="color: #FF6400;">is_utf8</span>=$(<span style="color: #fa8072;">file</span> <span style="color: #61CE3C;">"$i"</span> | grep <span style="color: #61CE3C;">'UTF-8'</span>)
<span class="linenr"> 5: </span>    <span style="color: #FBDE2D;">if</span> [ -z <span style="color: #61CE3C;">"$is_utf8"</span> ]
<span class="linenr"> 6: </span>    <span style="color: #FBDE2D;">then</span>
<span class="linenr"> 7: </span>        iconv -f gb2312 -t utf8 <span style="color: #61CE3C;">"$i"</span> -c -o tmp_lrc &amp;&amp; rm -f <span style="color: #61CE3C;">"$i"</span>
<span class="linenr"> 8: </span>        mv tmp_lrc <span style="color: #61CE3C;">"$i"</span>
<span class="linenr"> 9: </span>    <span style="color: #FBDE2D;">else</span>
<span class="linenr">10: </span>        <span style="color: #FBDE2D;">continue</span>;
<span class="linenr">11: </span>    <span style="color: #FBDE2D;">fi</span>
<span class="linenr">12: </span><span style="color: #FBDE2D;">done</span>
</pre>
</div>
<p>
功能就是将一个目录里扩展名为lrc的文件编码转换为utf8
</p>

<p>
这种方式有个弊端就是文件必须提前转换编码，如果程序是给别人使用，我们不可能要求别
人先将文件的编码转换好在运行程序，那么有没有什么办法可以直接在C程序里进行转换呢？
下面就看看如何在程序中进行转换，先看代码:
</p>
<div class="org-src-container">

<pre class="src src-C"><span class="linenr"> 1: </span><span style="color: #7fffd4;">#include</span><span style="color: #61CE3C;">&lt;stdio.h&gt;</span>
<span class="linenr"> 2: </span><span style="color: #7fffd4;">#include</span><span style="color: #61CE3C;">&lt;iconv.h&gt;</span>
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span style="color: #7fffd4;">#define</span> <span style="color: #FF6400;">MAXLINE</span> 1024
<span class="linenr"> 5: </span><span style="color: #8DA6CE;">int</span> <span style="color: #FF6400;">main</span>()
<span class="linenr"> 6: </span>{
<span class="linenr"> 7: </span>    <span style="color: #8DA6CE;">FILE</span> *<span style="color: #FF6400;">fp</span> = fopen(<span style="color: #61CE3C;">"she.lrc"</span>,<span style="color: #61CE3C;">"r"</span>);
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>    <span style="color: #8DA6CE;">char</span> <span style="color: #FF6400;">buf</span>[MAXLINE];
<span class="linenr">10: </span>    <span style="color: #8DA6CE;">char</span> <span style="color: #FF6400;">dest</span>[MAXLINE];
<span class="linenr">11: </span>    <span style="color: #8DA6CE;">char</span> *<span style="color: #FF6400;">in</span> = buf;
<span class="linenr">12: </span>    <span style="color: #8DA6CE;">char</span> *<span style="color: #FF6400;">out</span> = dest;
<span class="linenr">13: </span>    fgets(buf,MAXLINE,fp);
<span class="linenr">14: </span>
<span class="linenr">15: </span>    <span style="color: #8DA6CE;">iconv_t</span> <span style="color: #FF6400;">cd</span> = iconv_open(<span style="color: #61CE3C;">"UTF-8"</span>,<span style="color: #61CE3C;">"GBK"</span>);
<span class="linenr">16: </span>    <span style="color: #8DA6CE;">int</span> <span style="color: #FF6400;">lenght</span> = MAXLINE;
<span class="linenr">17: </span>    iconv(cd,&amp;in,&amp;lenght,&amp;out,&amp;lenght)
<span class="linenr">18: </span>    iconv_close(cd);
<span class="linenr">19: </span>    fputs(dest,stdout);
<span class="linenr">20: </span>    printf(<span style="color: #61CE3C;">"\n"</span>);
<span class="linenr">21: </span>    <span style="color: #FBDE2D;">return</span> 0;
<span class="linenr">22: </span>}
</pre>
</div>
<p>
上面的程序只是为了测试，所以有些错误处理代码去掉了，其中she.lrc是一个以gb2312编码
的歌词文件，用到了3个函数，icon<sub>open</sub>,iconv,icon<sub>close</sub>,这三个函数是libiconv库的接
口，这三个函数的详细介绍清参考:
<a href="http://www.gnu.org/savannah-checkouts/gnu/libiconv/documentation/libiconv-1.13/iconv_open.3.html">ICONV<sub>OPEN</sub></a>
<a href="http://www.gnu.org/savannah-checkouts/gnu/libiconv/documentation/libiconv-1.13/iconv.3.html">ICONV</a>
<a href="http://www.gnu.org/savannah-checkouts/gnu/libiconv/documentation/libiconv-1.13/iconv_close.3.html">ICONV<sub>CLOSE</sub></a>
</p>

<p>
这三个函数的帮助文档也可以直接man，很详细，使用的顺序也是先调
用iconv<sub>open创建描述符，然后调用iconv转换，最后调用iconv</sub><sub>close</sub>
关闭描述符，函数原型为：
</p>
<div class="org-src-container">

<pre class="src src-C"><span class="linenr">1: </span><span style="color: #8DA6CE;">iconv_t</span> <span style="color: #FF6400;">iconv_open</span>(<span style="color: #FBDE2D;">const</span> <span style="color: #8DA6CE;">char</span> *<span style="color: #FF6400;">tocode</span>, <span style="color: #FBDE2D;">const</span> <span style="color: #8DA6CE;">char</span> *<span style="color: #FF6400;">fromcode</span>)
<span class="linenr">2: </span><span style="color: #8DA6CE;">size_t</span> <span style="color: #FF6400;">iconv</span>(<span style="color: #8DA6CE;">iconv_t</span> <span style="color: #FF6400;">cd</span>,
<span class="linenr">3: </span>                    <span style="color: #8DA6CE;">char</span> **<span style="color: #FF6400;">inbuf</span>, <span style="color: #8DA6CE;">size_t</span> *<span style="color: #FF6400;">inbytesleft</span>,
<span class="linenr">4: </span>                    <span style="color: #8DA6CE;">char</span> **<span style="color: #FF6400;">outbuf</span>, <span style="color: #8DA6CE;">size_t</span> *<span style="color: #FF6400;">outbytesleft</span>);
<span class="linenr">5: </span> <span style="color: #8DA6CE;">int</span> <span style="color: #FF6400;">iconv_close</span>(<span style="color: #8DA6CE;">iconv_t</span> <span style="color: #FF6400;">cd</span>);
</pre>
</div>
<p>
其中fromcode和tocode是编码方式，shell下输入iconv &#x2013;list会列出支持的编码方式。
</p>
</div>
</div>
</div>
<div id="disqus_comment">
  <div id="disqus_thread"></div>
    <script type="text/javascript">
        var url = window.location.pathname;
        var disqus_identifier = url.substring(url.lastIndexOf('/')+1);
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'yuyang'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
<!-- begin footer -->
<div id="footer">
  <hr />
  <ul class="links">
    <li>© 2013 Yu Yang's Blog, Created by org-mode and dropbox</li>
    <li><a href="/sitemap.tt">Sitemap</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    <li><a href="/about.html">About Me</a></li>
    <li><a href="#">Back to Top</a></li>
  </ul>
</div>
<!-- end footer --></body>
</html>
